{% extends "users/layout/app.html" %}
{% block content %}
<style>
    .table > :not(:last-child) > :last-child > *, .jsgrid .jsgrid-table > :not(:last-child) > :last-child > *
        {
            border: 1px solid #515151 !important;  
        }
table .select2{
        width: 172.8646px !important;
    }
    table .select2-container--default .select2-selection--single:read-only{
        background-color: 1c1c1c !important;
        border: 1px solid #000 !important;
        height: 10px !important;
    }
    table .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 10px !important;
    }
    table .input{
        border: 1px solid #000 !important;
        height: 28px;
        border-radius: 3px;
    }
</style>
<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Generate Purchase Invoice</h4>
                <p class="card-description">
                Generate purchase invoice from here
                </p>
                <form class="forms-sample" action="{% url 'generate-purchase-invoice' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{get_data.id}}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Entity</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100 entity_data" name="entity_id"  required>
                                        <option value="" disabled>Select Entity</option>
                                        {% for x in list_entity %}
                                        <option value="{{x.id}}" {% if x.id|slugify == get_data.entity_id.id|slugify %} selected {% endif %}>{{x.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Vendor </label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100" name="supplier_id" id="supplier_id" required>
                                        <option value="" disabled selected>Select Supplier</option>
                                        {% for x in list_supplier %}
                                        <option value="{{x.id}}" {% if x.id|slugify == get_data.supplier_id.id|slugify %} selected {% endif %}>{{x.name}}</option>

                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                              
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Branch</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100 branch" name="branch_id" required>
                                        <option value="" disabled selected>Select Branch</option>
                                        {% for x in list_branch %}
                                        <option value="{{x.id}}" {% if x.id|slugify == get_data.branch_id.id|slugify %} selected {% endif %}>{{x.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Voucher Type</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100" name="voucher_type_id" id="voucher_type" required>
                                        <option value="" disabled selected>Select Voucher Type</option>
                                        {% for x in list_voucher_types %}
                                        <option value="{{x.id}}" {% if x.id|slugify == get_data.voucher_series_id.id|slugify %} selected {% endif %}>{{x.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Order Number</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control order_number" id="order_number" placeholder="Order Number" name="order_number" readonly>
                                    <input type="hidden" name="order_number" class="order_number">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Date</label>
                                <div class="col-sm-9">
                                    <input type="date" class="form-control" id="date" placeholder="Date" name="date" value="{{get_data.date}}" required>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Due Date</label>
                                <div class="col-sm-9">
                                    <input type="date" class="form-control" id="dueDate" placeholder="Due Date" name="due_date" value="{{get_data.due_date}}" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Due Days</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control due_days" placeholder="Due Days" name="due_days" value="{{get_data.due_days}}" readonly>
                                    <input type="hidden" class="due_days" name="due_days" value="{{get_data.due_days}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Debit Ledger</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100"  name="debit_ledger_id" required>
                                        <option value="" disabled>Select Debit Ledger</option>
                                        {% for x in get_debit_account_ledger %}
                                        <option value="{{x.id}}">{{x.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Credit Ledger</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100" name="credit_ledger_id" required>
                                        <option value="" disabled>Select Credit Ledger</option>
                                        {% for x in get_credit_account_ledger %}
                                        <option value="{{x.id}}">{{x.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Shipping address</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="shipping_address" placeholder="Type here" name="shipping_address"  rows="4">{{get_data.shipping_address}}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Receiver address</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="receiver_address" placeholder="Type here" name="receiver_address" rows="4" >{{get_data.receiver_address}}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Weight</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control"  placeholder="Type here" name="weight" value="{{get_data.weight}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Lr No.</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control"  placeholder="Type here" name="lrno" value="{{get_data.lrno}}">
                                </div>
                            </div>
                        </div>
                        
                        
                        
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Number of Cases</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control"  placeholder="Type here" name="no_of_cases" value="{{get_data.no_of_cases}}">
                                </div>
                            </div>
                        </div>
                        

                        

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Supplier GSTIN</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="cgstin" placeholder="Type here" name="cgstin" id="cgstin" value="{{get_data.supplier_id.cst}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">E way Bill No.</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control"  placeholder="Type here" name="ewaybill" value="{{get_data.ewaybill}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Vehicle No.</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control"  placeholder="Type here" name="vehicle_number" value="{{get_data.vehicle_number}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Transport Id</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" placeholder="Type here" name="transportid" value="{{get_data.transportid}}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Pricing Level</label>
                                <div class="col-sm-9">
                                    <select class="js-example-basic-single w-100" name="pricing_lvl" >
                                        <option value="" disabled selected>Select Level</option>
                                        {% for x in list_pricing_level %}
                                        {% if get_data.pricing_lvl %}
                                              <option value="{{x.id}}" {% if x.id|slugify == get_data.pricing_lvl.id|slugify %} selected {% endif %}>{{x.name}}</option>
                                        {% else%}
                                        <option value="{{x.id}}">{{x.name}}</option>

                                        {% endif%}
                                     {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="table-responsive">
                            <table id="myTable" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Product Code</th>
                                        <th>Quanity</th>
                                        <th>Unit</th>
                                        <th>Godown</th>
                                        <th>Rack</th>
                                        <th>Batch</th>
                                        <th>Rate</th>
                                        <th>Tax</th>
                                        <th>Tax Amount</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in get_order_product %}
                                    <input type="hidden" name="product[{{data.key}}]id" value="{{data.id}}">
                                    <tr>
                                        <td>
                                            <select class="js-example-basic-single w-100 selectatr" name="product[{{data.key}}]product_id" id="product_id{{data.key}}" data-id="{{data.key}}" required>
                                                <option value="" disabled selected>Select Product</option>
                                                {% for x in list_products %}
                                                <option value="{{x.id}}" {% if x.id|slugify == data.product_id.id|slugify %} selected {% endif %}>{{x.name}}</option>
                                                {% endfor %}
                                            </select>
                                            <p class="card-description" style="color: red; display:none; margin-bottom: -20px !important;" id="error0">
                                                Please select product
                                            </p>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100 selectatr" name="product[{{data.key}}]product_code" id="product_code{{data.key}}" required>
                                                <option value="" disabled selected>Product Code</option>
                                                <option value="{{data.product_code}}" selected>{{data.product_code}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input class="input" type="text" value="{{data.quantity}}" name="product[{{data.key}}]quantity" id="quantity{{data.key}}" data-id="{{data.key}}" required/>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100" name="product[{{data.key}}]unit_id" id="unit_id{{data.key}}">
                                                <option value="" disabled selected>Select Unit</option>
                                                <option value="{{data.unit_id.id}}" selected>{{data.unit_id.formal_name}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100" name="product[{{data.key}}]godown_id" id="godown_id{{data.key}}">
                                                <option value="" disabled selected>Select Godown</option>
                                                <option value="{{data.godown_id.id}}" selected>{{data.godown_id.name}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100" name="product[{{data.key}}]rack_id" id="rack_id{{data.key}}">
                                                <option value="" disabled selected>Select Rack</option>
                                                {% if data.rack_id %}
                                                <option value="{{data.rack_id.id}}" selected>{{data.rack_id.name}}</option>
                                                {% endif %}
                                            </select>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100" name="product[{{data.key}}]batch_id" id="batch_id{{data.key}}">
                                                <option value="" disabled selected>Select Batch</option>
                                                {% for batch in data.get_batch %}
                                                <option value="{{batch.id}}" {% if batch.id|slugify == data.batch_id.id|slugify %} selected {% endif %}>{{batch.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input class="input" type="text" value="{{data.purchase_rate}}" name="product[{{data.key}}]purchase_rate" id="purchase_rate{{data.key}}" data-id="{{data.key}}" required/>
                                        </td>
                                        <td>
                                            <select class="js-example-basic-single w-100" name="product[{{data.key}}]tax_id" id="tax_id{{data.key}}">
                                                <option value="" disabled selected>Select Tax</option>
                                                <option value="{{data.tax_id.id}}" selected>{{data.tax_id.tax}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input class="input tax_amount{{data.key}}" type="text" value="{{data.tax_amount}}" name="product[{{data.key}}]tax_amont" id="tax_amont{{data.key}}" readonly/>
                                            <input type="hidden" class="tax_amount{{data.key}}" name="product[{{data.key}}]tax_amount" value="{{data.tax_amount}}">
                                        </td>
                                        <td>
                                            <input class="input amount" type="text" value="{{data.amount}}" id="amount{{data.key}}" data-id="{{data.key}}" readonly/>
                                            <input type="hidden" class="amount{{data.key}}" name="product[{{data.key}}]amount" value="{{data.amount}}">
                                        </td>
                                        <td>
                                            <button type="button" class="addRow btn-add btn btn-block btn-success btn-sm font-weight-medium auth-form-btn me-3">
                                                Add
                                            </button>
                                            <a href="{% url 'delete-order-purchase-product-invoice' %}?id={{data.id}}" class="removeRow btn-add btn btn-block btn-danger btn-sm font-weight-medium auth-form-btn">
                                                remove
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {% if list_additional_product %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <div class="form-group">
                                    <div class="table-responsive">
                                        <table id="additionalcost" class="table table-striped addrowtable" >
                                            <thead>
                                                <tr>
                                                    <th>Product Name</th>
                                                    
                                                    <th colspan="2">Charge</th>
                                                </tr>
                                            </thead>

                                               
                                            <tbody>
                                                {% for data in list_additional_product %}
                                            
                                                <input type="hidden" name="product{{data.key}}" value="{{data.key}}">
                                                <tr>
                                                    <td>
                                                        <select class="js-example-basic-single w-100 selectadd" name="additionalproduct{{data.key}}" id="additionalproduct{{data.key}}" data-id="{{data.key}}"  >
                                                            <option value="" selected>Select Product</option>
                                                            {% for x in list_products %}
                                                            <option value="{{x.id}}" {% if x.id|slugify == data.id|slugify %} selected {% endif %}>{{data.id}}{{x.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <p class="card-description" style="color: red; display:none; margin-bottom: -20px !important;" >
                                                            Please select product
                                                        </p>
                                                    </td>
                                                    
                                                    <td>
                                                        <input class="amount" type="text" id="additionalproductamount{{data.key}}" name="additionalproductamount{{data.key}}" data-id="0" value="{{data.amount}}">
                                                        
                                                    </td>
                                                    <td>
                                                        <button type="button" class="addRowadditional btn-add btn btn-block btn-success btn-sm font-weight-medium auth-form-btn me-3">
                                                            Add
                                                        </button>
                                                        <button type="button" class="removeRowadditional btn-add btn btn-block btn-danger btn-sm font-weight-medium auth-form-btn">
                                                            remove
                                                        </button>
                                                        
                                                    </td>
                                                </tr>
                                                {% endfor %}

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                        </div>
                    </div>
                    
                    {% else %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <div class="form-group">
                                    <div class="table-responsive">
                                        <table id="additionalcost" class="table table-striped addrowtable" >
                                            <thead>
                                                <tr>
                                                    <th>Product Name</th>
                                                    
                                                    <th colspan="2">Charge</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <select class="js-example-basic-single w-100 selectadd" name="additionalproduct0" id="additionalproduct0" data-id="0" >
                                                            <option value="" selected>Select Product</option>
                                                            {% for x in list_products %}
                                                            <option value="{{x.id}}">{{x.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                        <p class="card-description" style="color: red; display:none; margin-bottom: -20px !important;" >
                                                            Please select product
                                                        </p>
                                                    </td>
                                                    
                                                    <td>
                                                        <input class="amount" type="text" id="additionalproductamount0" name="additionalproductamount0" data-id="0" >
                                                        
                                                    </td>
                                                    <td>
                                                        <button type="button" class="addRowadditional btn-add btn btn-block btn-success btn-sm font-weight-medium auth-form-btn me-3">
                                                            Add
                                                        </button>
                                                        <button type="button" class="removeRowadditional btn-add btn btn-block btn-danger btn-sm font-weight-medium auth-form-btn">
                                                            remove
                                                        </button>
                                                        
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <div class="col-md-6">
                        <div class="row">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Description</label>
                                <div class="col-sm-9">
                                    <textarea class="form-control" id="exampleTextarea1" placeholder="Description" name="description" rows="9"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label"> Image</label>
                                <div class="col-sm-9">
                                    <input type="file" name="image" class="file-upload-default" id="image">
                                    <div class="input-group col-xs-12">
                                        <input type="text" class="form-control file-upload-info" style="width: 20px !important;" disabled placeholder="Upload Image" style="height: 45px;">
                                        <span class="input-group-append">
                                            <button class="file-upload-browse btn btn-primary" style="border-radius: 199px;margin-top: -25px;margin-left: -132px !important" type="button">Upload</button>
                                        </span>
                                    </div>
                                    
                                </div>
                            </div>
                                       
                         </div>
                        
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label">Total Amount</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control total_amount" id="total_amount" placeholder="Total Amount" name="total_amount" readonly>
                                    <input type="hidden" class="total_amount" name="total_amount">
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <input type="hidden" name="number_of_input" value="{{total_product}}" id="number_of_input">
                    <input type="hidden" name="number_of_additionalinput"  id="number_of_additionalinput" value="{{total_additional_order_product}}">
                    
                <div class="row">
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary me-2">Submit</button>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>




<!-- get branch details and supplier detail on change and additional -->


<script type="text/javascript">
    $(document).ready(function () {
        $(document).on('change', '#supplier_id', function(event){
            var supplier_id = $(this).val();

            $.ajax({
                type: 'POST',
                url: "{% url 'get-supplier-data' %}",  // Update the URL based on your Django URL configuration
                data: {
                    'supplier_id': supplier_id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Ensure to include CSRF token
                },
                success: function (data) {
                    console.log(data.address)
                    $('#shipping_address').val(data.address)
                    $('#cgstin').val(data.cst)

                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        
            
        });


        $(document).on('change', '#branch_id', function(event){
            var branch_id = $(this).val();

            $.ajax({
                type: 'POST',
                url: "{% url 'get-branchs-details' %}",  // Update the URL based on your Django URL configuration
                data: {
                    'branch_id': branch_id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Ensure to include CSRF token
                },
                success: function (data) {
                    console.log(data.address)
                    $('#receiver_address').val(data.address)

                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        
            
        });



    });

    
</script>

<script>

    
    $(document).ready(function () {
        
        additionalupdateRemoveButtons();

        $(document).on("click", "#additionalcost .addRowadditional", function () {
            var number_of_input = $('#number_of_additionalinput').val();
            var i               = parseInt(number_of_input) + 1;
            $('#number_of_additionalinput').val(i);
            console.log(i)
            var newRow = '<tr>' +
                        '<td>' +
                            '<select class="js-example-basic-single w-100 selectadd" name="additionalproduct' + i + '" id="additionalproduct' + i + '" data-id="' + i + '"  > ' +
                            '<option value=""  selected>Select Product</option>';

                        // Loop through list_products to add options
                                '{% for x in list_products %}'
                                newRow += '<option value="{{ x.id }}">{{ x.name }}</option>';
                                '{% endfor %}'
                newRow += '<td>' +
                        '<input class="amount" type="text"  id="additionalproductamount' + i + '" name="additionalproductamount' + i + '" data-id="' + i + '">' +
                        '</td>'+
                        '<td>' +
                        '<button type="button" class="addRowadditional btn-add btn btn-block btn-success btn-sm font-weight-medium auth-form-btn me-3">Add</button>' +
                        '<button type="button" class="removeRowadditional btn-add btn btn-block btn-danger btn-sm font-weight-medium auth-form-btn">Remove</button>' +
                        '</td>' +
                        '</tr>';
            $('#additionalcost tbody').append(newRow);
            $('.js-example-basic-single').select2();
            additionalupdateRemoveButtons();

        })

        function updateadditionalitemsRemoveButtons() {
            var rowCount    = $("#additionalcost tbody tr").length;

            // Show/hide remove buttons based on the number of rows
            if (rowCount > 1) {
                $(".removeRowadditional").show();
            } else {
                $(".removeRowadditional").hide();
            }
        }
        // Remove row
        $("#additionalcost").on("click", ".removeRowadditional", function () {
            var number_of_input     = $('#number_of_additionalinput').val();
            var i                   = parseInt(number_of_input) - parseInt(1);
            
            $('#number_of_additionalinput').val(i);

            $(this).closest("tr").remove();
            updateadditionalitemsRemoveButtons();
            calculateTotalAmount()
        });


        function additionalupdateRemoveButtons() {
            var rowCount    = $("#additionalcost tbody tr").length;
            console.log("heyyyy")
            // Show/hide remove buttons based on the number of rows
            if (rowCount > 1) {
                $(".removeRowadditional").show();
            } else {
                $(".removeRowadditional").hide();
            }
        }

    
        $(document).on("change", ".selectadd", function () {
            var product_id  = $(this).val();
            var get_id      = $(this).attr('data-id');
            

            $.ajax({
                url:"{% url 'get-product-data' %}",
                method:"get",
                data:{product_id:product_id},
                success:function(data)
                {  
                    var get_data            = data['models_to_return']
                    
                    var purchase_rate       = get_data['purchase_rate'];
                    
                    $('#additionalproductamount'+get_id).val(purchase_rate);
                    
                    
                    calculateTotalAmount();
                } 
            });
        });

        $(document).on("change", ".amount", function () {
            var get_id      = $(this).attr('data-id');
            var product_id  = $('#additionalproduct'+get_id).val();
            console.log(product_id)

            if(product_id)
            {
                calculateTotalAmount()
            }
            else{
                console.log(get_id);
            }
        });
        function calculateTotalAmount() {
            var totalAmount = 0;

            $('.amount').each(function () {
                var rowAmount = parseFloat($(this).val()) || 0;
                totalAmount += rowAmount;
            });

            $('.total_amount').val(totalAmount.toFixed(2));
        }

    });
</script>
        
<!-- end of additional -->





<script>
    $(document).ready(function () {
        updateRemoveButtons();

        $(document).on("click", "#myTable .addRow", function () {
            var number_of_input = $('#number_of_input').val();
            var i               = parseInt(number_of_input) + 1;
            $('#number_of_input').val(i);

            var newRow          =   '<tr>' +
                                    '<td><select class="js-example-basic-single w-100 selectatr" name="product['+i+']product_id" id="product_id'+i+'" data-id="'+i+'" required>' +
                                    '<option value="" disabled selected>Select Product</option>' +
                                    '{% for x in list_products %}' +
                                    '<option value="{{x.id}}">{{x.name}}</option>' +
                                    '{% endfor %}' +
                                    '</select><p class="card-description" style="color: red; display:none; margin-bottom: -20px !important;" id="error'+i+'" >Please select product</p></td>' +
                                    '<td><select class="js-example-basic-single w-100" name="product['+i+']product_code" id="product_code'+i+'" required>' +
                                    '<option value="" disabled selected>Product Code</option>' +
                                    '</select></td>' +
                                    '<td><input class="input" type="text" name="product['+i+']quantity" id="quantity'+i+'" data-id="'+i+'" required/></td>' +
                                    '<td><select class="js-example-basic-single w-100" name="product['+i+']unit_id" id="unit_id'+i+'" required>' +
                                    '<option value="" disabled selected>Select Unit</option>' +
                                    '</select></td>' +
                                    '<td>'+
                                    '<select class="js-example-basic-single w-100" name="product['+i+']godown_id" id="godown_id'+i+'">'+
                                    '<option value="" disabled selected>Select Godown</option>'+
                                    '</select>'+
                                    '</td>'+
                                    '<td>'+
                                    '<select class="js-example-basic-single w-100" name="product['+i+']rack_id" id="rack_id'+i+'">'+
                                    '<option value="" disabled selected>Select Rack</option>'+
                                    '</select>'+
                                    '</td>'+
                                    '<td>'+
                                    '<select class="js-example-basic-single w-100" name="product['+i+']batch_id" id="batch_id'+i+'">'+
                                    '<option value="" disabled selected>Select Batch</option>'+
                                    '</select>'+
                                    '</td>'+
                                    '<td><input class="input" type="text" name="product['+i+']purchase_rate" id="purchase_rate'+i+'" data-id="'+i+'" required/></td>' +
                                    '<td>'+
                                    '<select class="js-example-basic-single w-100" name="product['+i+']tax_id" id="tax_id'+i+'">'+
                                    '<option value="" disabled selected>Select Tax</option>'+
                                    '</select>'+
                                    '</td>'+
                                    '<td>'+
                                    '<input class="input tax_amount'+i+'" type="text" name="product['+i+']tax_amont" id="tax_amont'+i+'" readonly/>'+
                                    '<input type="hidden" class="tax_amount'+i+'" name="product['+i+']tax_amount">'+
                                    '</td>'+
                                    '<td><input class="input amount" type="text" name="amount['+i+']" id="amount'+i+'" readonly/><input type="hidden" class="amount'+i+'" name="product['+i+']amount"></td>' +
                                    '<td>' +
                                    '<button type="button" class="addRow btn-add btn btn-block btn-success btn-sm font-weight-medium auth-form-btn me-3">Add</button>' +
                                    '<button type="button" class="removeRow btn-add btn btn-block btn-danger btn-sm font-weight-medium auth-form-btn">Remove</button>' +
                                    '</td>' +
                                    '</tr>';

            // Append the new row to the table
            $('#myTable tbody').append(newRow);

            // Initialize Select2 for the new row's selects
            $('.js-example-basic-single').select2();
        
            updateRemoveButtons();
        });

        // Remove row
        $("#myTable").on("click", ".removeRow", function () {
            var number_of_input     = $('#number_of_input').val();
            var i                   = parseInt(number_of_input) - parseInt(1);
            
            $('#number_of_input').val(i);

            $(this).closest("tr").remove();
            calculateTotalAmount();
            updateRemoveButtons();
            
        });

        function updateRemoveButtons() {
            var rowCount    = $("#myTable tbody tr").length;

            // Show/hide remove buttons based on the number of rows
            if (rowCount > 1) {
                $(".removeRow").show();
            } else {
                $(".removeRow").hide();
            }
        }
    });
</script>
<script>
    function calculateTotalAmount() {
        var totalAmount = 0;

        $('.amount').each(function () {
            var rowAmount = parseFloat($(this).val()) || 0;
            totalAmount += rowAmount;
        });
        
        $('.total_amount').val(totalAmount.toFixed(2));
    }
</script>
<script>

    
    $(document).ready(function () {
        calculateTotalAmount();
        $(document).on("change", ".selectatr", function () {
            var product_id  = $(this).val();
            var get_id      = $(this).attr('data-id');
            var quantity    = $('#quantity'+get_id).val();
            
            $('#error'+get_id).hide();

            $.ajax({
                url:"{% url 'get-product-data' %}",
                method:"get",
                data:{product_id:product_id},
                success:function(data)
                {  
                    var get_data            = data['models_to_return']
                    var product_code        = get_data['product_code'];
                    var unit_id             = get_data['unit_id'];
                    var unit                = get_data['unit'];
                    var unit_formal_name    = get_data['unit_formal_name'];
                    var purchase_rate       = get_data['purchase_rate'];
                    var tax                 = get_data['tax'];
                    var tax_id              = get_data['tax_id'];
                    var tax_rate            = get_data['tax_rate'];
                    var godown_id           = get_data['godown_id'];
                    var godown_name         = get_data['godown_name'];
                    var rack_id             = get_data['rack_id'];
                    var rack_name           = get_data['rack_name'];
                    var batch_data          = get_data['batch_data'];

                    tax_amount              = 0;
                    $('#tax_id'+get_id).empty();
                    $('.tax_amount'+get_id).val(0);
                    if(tax){
                        var tax_amount      = (tax_rate / 100) * purchase_rate;

                        $('#tax_id'+get_id).empty();
                        $('#tax_id'+get_id).append(`
                                    <option value="" disabled>Unit</option>
                                    <option value="`+tax_id+`" selected>`+tax+`</option>
                                `);

                        $('.tax_amount'+get_id).val(tax_amount);
                    }
                    
                    $('#batch_id'+get_id).empty();
                    $.each( batch_data, function( key1, value ) 
                    {
                        $('#batch_id'+get_id).append(`<option value="`+value['id']+`">`+value['name']+`</option>`);
                    });

                    $('#product_code'+get_id).empty();
                    $('#product_code'+get_id).append(`
                                <option value="" disabled>Product Code</option>
                                <option value="`+product_code+`" selected>`+product_code+`</option>
                            `);
                    
                    $('#unit_id'+get_id).empty();
                    $('#unit_id'+get_id).append(`
                                <option value="" disabled>Unit</option>
                                <option value="`+unit_id+`" selected>`+unit_formal_name+`</option>
                            `);

                    $('#godown_id'+get_id).empty();
                    $('#godown_id'+get_id).append(`
                                <option value="" disabled>Godown</option>
                                <option value="`+godown_id+`" selected>`+godown_name+`</option>
                            `);
                    
                    $('#rack_id'+get_id).empty();
                    $('#rack_id'+get_id).append(`
                                <option value="" disabled>Rack</option>
                                <option value="`+rack_id+`" selected>`+rack_name+`</option>
                            `);

                    $('#purchase_rate'+get_id).val(purchase_rate);
                    
                    if(quantity){
                        
                        var total_amount    = parseInt(quantity) * parseFloat(purchase_rate) + tax_amount;
                        
                        $('#amount'+get_id).val(total_amount);
                        $('.amount'+get_id).val(total_amount);
                    } 
                    calculateTotalAmount();
                } 
            });
        });


        $(document).on("change", ".input", function () {
            var get_id      = $(this).attr('data-id');
            var product_id  = $('#product_id'+get_id).val();
            var quantity    = $('#quantity'+get_id).val();
            var tax_amount  = $('.tax_amount'+get_id).val()

            if(product_id)
            {
                var purchase_rate   = $('#purchase_rate'+get_id).val();
                var total_amount    = parseInt(quantity) * parseFloat(purchase_rate) + parseFloat(tax_amount);
                        
                $('#amount'+get_id).val(total_amount);
                $('.amount'+get_id).val(total_amount);
            }
            else{
                console.log(get_id);
                $('#error'+get_id).show();
            }
            calculateTotalAmount();
        });
    });

</script>
<script>
    $(document).ready(function () {
        $(document).on("change", "#voucher_type", function () {
            var voucher_series_id   = $(this).val();
            $.ajax({
                url:"{% url 'get-purchase-voucher-number' %}",
                method:"get",
                data:{voucher_series_id:voucher_series_id},
                success:function(data)
                {  
                    voucher_number  = data['voucher_number'];
                    $('.order_number').val(voucher_number);  
                } 
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#date').on('change', function () {
            var selectedDate    = $(this).val();
            
            $('#dueDate').attr('min', selectedDate);
            calculateDueDays();
        });

        $('#dueDate').on('change', function () {
            var selectedDate    = $(this).val();

            $('#date').attr('max', selectedDate);
            calculateDueDays();
        });
    });

    function calculateDueDays()
    {
        var startDate       = new Date($('#date').val());
        var dueDate         = new Date($('#dueDate').val());

        if(startDate != 'Invalid Date' && dueDate != 'Invalid Date')
        {
            var timeDifference  = dueDate.getTime() - startDate.getTime();
            var daysDifference  = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
            
            $('.due_days').val(daysDifference);
        }
    }
</script>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $(document).on('change', '.entity_data', function(event){
            var entity_id = $(this).val();

            $.ajax({
                type: 'POST',
                url: "{% url 'get-single-entity-branch' %}",  // Update the URL based on your Django URL configuration
                data: {
                    'entity_id': entity_id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Ensure to include CSRF token
                },
                success: function (data) {
                    var branches        = data.branches;
                    var branchSelect    = $('.branch');
                    branchSelect.empty();  // Clear previous options
                    branchSelect.append('<option value="" disabled selected>Select Branch</option>');
                    $.each(branches, function (index, branch) {
                        branchSelect.append('<option value="' + branch.id + '">' + branch.name + '</option>');
                    });
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        });
    });
</script>
{% endblock %}